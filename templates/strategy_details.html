{% extends "base.html" %}
{% block title %}Strategy Details{% endblock %}
{% block content %}
  <div id="flash-message-area"></div>

  <h4 class="mb-4">{{ strategy.name }}</h4>
  <div class="accordion mb-4" id="accordionExample">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingOne">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
          Strategy Parameters
        </button>
      </h2>
      <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
        <div class="accordion-body">
          <div class="row g-4">
            <!-- Entry Condition -->
            <div class="col-12 col-md-4">
              <div class="fw-bold">Entry Condition</div>
              <div>{{ strategy.entry_basis.title() }} <span class="text-muted">({{ strategy.entry_percentage|int }}%)</span></div>
            </div>
            <!-- Re-entry Conditions -->
            <div class="col-12 col-md-4">
              <div class="fw-bold">Re-entry Conditions</div>
              {% if reentry_params %}
                <ul class="list-unstyled mb-0">
                  {% for key, cfg in reentry_params.items() %}
                    <li>
                      <i class="bi bi-arrow-repeat text-success me-1"></i>
                      <strong>{{ key.replace('_',' ').title() }}:</strong>
                      {% if cfg.basis is defined %} {{ cfg.basis.title() }}{% endif %}
                      {% if cfg.percentage is defined %} <span class="text-muted">({{ cfg.percentage|int }}%)</span>{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted">None</div>
              {% endif %}
            </div>
            <!-- Investment -->
            <div class="col-12 col-md-4">
              <div class="fw-bold">Investment</div>
              <div>{{ strategy.investment_type.title() }} <span class="text-muted">— {{ strategy.investment_value|int }}</span></div>
            </div>
            <!-- Profit Target -->
            <div class="col-12 col-md-4">
              <div class="fw-bold">Profit Target</div>
              <div>{{ strategy.profit_target_type.title() }} <span class="text-muted">— {{ strategy.profit_target_value|int }}</span></div>
            </div>
            <!-- Stop Loss -->
            <div class="col-12 col-md-4">
              <div class="fw-bold">Stop Loss</div>
              <div>{{ strategy.stop_loss_type.title() }} <span class="text-muted">— {{ strategy.stop_loss_value|int }}</span></div>
            </div>
            <!-- Execution Time -->
            <div class="col-12 col-md-4">
              <div class="fw-bold">Execution Time</div>
              <div>{{ strategy.execution_time or '-' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>  

  <!-- Modal for editing parameters (investment, profit target, stop loss, execution time) -->
  <div class="modal" id="editParamsModal">
    <div class="modal-dialog" role="document">
      <form method="POST" action="{{ url_for('strategy_details', strategy_id=strategy.id) }}">
        {{ csrf_field() }}
        <input type="hidden" name="update_set" value="1">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editParamsModalLabel">Edit Trade Parameters</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Editable fields: Investment, Profit Target, Stop Loss, Execution Time -->
            <div class="form-group">
              <label>Investment</label>
              <div class="input-group">
                <select name="investment_type" class="form-control" required>
                  <option value="quantity" {% if strategy.investment_type == "quantity" %}selected{% endif %}>Quantity</option>
                  <option value="fixed" {% if strategy.investment_type == "fixed" %}selected{% endif %}>Fixed Amount</option>
                </select>
                <input type="number" step="1" name="investment_value" class="form-control" placeholder="Value" value="{{ strategy.investment_value }}" required>
              </div>
            </div>
             <!-- Profit Target: Dropdown + Input -->
            <div class="form-group">
              <label>Profit Target</label>
              <div class="input-group">
                <select name="profit_target_type" class="form-control" required>
                  <option value="percentage" {% if strategy.profit_target_type == "percentage" %}selected{% endif %}>Percentage</option>
                  <option value="fixed" {% if strategy.profit_target_type == "fixed" %}selected{% endif %}>Fixed Amount</option>
                </select>
                <input type="number" step="1" name="profit_target_value" class="form-control" placeholder="Value" value="{{ strategy.profit_target_value }}" required>
              </div>
            </div>
            <!-- Stop Loss: Dropdown + Input -->
            <div class="form-group">
              <label>Stop Loss</label>
              <div class="input-group">
                <select name="stop_loss_type" class="form-control">
                  <option value="percentage" {% if strategy.stop_loss_type == "percentage" %}selected{% endif %}>Percentage</option>
                  <option value="fixed" {% if strategy.stop_loss_type == "fixed" %}selected{% endif %}>Fixed Amount</option>
                </select>
                <input type="number" step="1" name="stop_loss_value" class="form-control" placeholder="Value" value="{{ strategy.stop_loss_value }}">
              </div>
            </div>
            <!-- Execution Time: Dropdown + Time Picker -->
            <div class="form-group">
              <label>Execution Time</label>
              <div class="input-group">
                <select name="execution_time_type" class="form-control">
                  <option value="before" {% if strategy.execution_time.startswith("before") %}selected{% endif %}>Before</option>
                  <option value="after" {% if strategy.execution_time.startswith("after") %}selected{% endif %}>After</option>
                </select>
                <!-- Assume execution_time is stored like "before 10:00" -->
                <input type="time" name="execution_time_value" class="form-control" value="{{ strategy.execution_time.split(' ')[1] if strategy.execution_time.split(' ')|length > 1 else '' }}">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Update Parameters</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Adding New Script(s) -->
  <div class="modal" id="addScriptModal">
    <div class="modal-dialog" role="document">
      <form method="POST" action="{{ url_for('add_script', strategy_id=strategy.id) }}">
        {{ csrf_field() }}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addScriptModalLabel">Add New Script(s)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Search Script -->
            <div class="form-group">
              <label>Search Script</label>
              <div class="position-relative">
                <input type="text" id="modalScriptSearch" class="form-control" placeholder="Enter script name">
                <!-- spinner, hidden by default -->
                <div id="modalSearchLoader"
                    class="spinner-border spinner-border-sm position-absolute top-50 end-0 translate-middle-y me-3"
                    style="display: none"
                    role="status">
                  <span class="visually-hidden">Loading…</span>
                </div>
              </div>
              <div id="modalSearchResults" class="mt-2"></div>
          </div>
            <!-- Selected Scripts -->
            <div class="form-group mt-3">
              <label>Selected Script(s) (Max 10):</label>
              <div id="modalSelectedScripts" class="border p-2" style="min-height: 50px;"></div>
              <!-- Hidden field to store selected script JSON -->
              <input type="hidden" name="selected_scripts" id="modal_selected_scripts">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add Script(s)</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

    <div class="d-flex justify-content-between align-items-center bg-white border-bottom pb-2">
      <h5 class="mb-0">Deployed Scripts	</h5>    
      <!-- Right side: wrap both buttons in one flex item -->
      <div class="btn-toolbar" role="toolbar">
        <div class="btn-group me-2" role="group">
          {% if strategy.scripts|length < 10 %}
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addScriptModal"><i class="bi bi-plus-circle"></i> Add New Script</button>
          {% else %}
            <button type="button" class="btn btn-outline-primary" disabled>Maximum Scripts Reached</button>
          {% endif %}
        </div>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#editParamsModal"><i class="bi bi-pencil-square"></i> Edit Parameters</button>
        </div>
      </div>
    </div>
      <table class="table table-hover m-0">
        <thead>
          <tr>
            <th class="fw-normal">#</th>
            <th class="fw-normal">Script Name</th>
            <th class="fw-normal">Current LTP</th>
            <th class="fw-normal">Purchased Qty</th>
            <th class="fw-normal">Average Price</th>
            <th class="fw-normal">Investment</th>
            <th class="fw-normal">Current Value</th>
            <th class="fw-normal">P&L</th>
            <th class="fw-normal">P&L %</th>
            <th class="fw-normal">Total Trades</th>
            <th class="fw-normal">Status</th>
            <th class="fw-normal">Actions</th>
          </tr>
        </thead>
        <tbody class="align-middle">
          {% for script in strategy.scripts %}
          {% set purchased_qty = script.cumulative_qty or 0 %}
          {% set avg_price = script.weighted_avg_price or 0 %}
          {% set investment = purchased_qty * avg_price %}
          {% set current_value = purchased_qty * (script.ltp or 0) %}
          {% set pnl = current_value - investment %}
          {% set pnl_percent = (pnl / investment * 100) if investment else 0 %}
          <tr id="row-{{ script.script_name }}" data-script-id="{{ script.id }}" data-script-name="{{ script.script_name }}">
            <td>{{ loop.index }}</td>
            <td>{{ script.script_name }}</td>
            <td data-field="current_ltp">{{ script.ltp or 0 }}</td>
            <td data-field="purchasedQty">{{ purchased_qty|int}}</td>
            <td data-field="avgPrice">{{ avg_price }}</td>
            <td data-field="investment">{{ investment }}</td>
            <td data-field="currentValue">{{ current_value }}</td>
            <td data-field="pnl">{{ pnl }}</td>
            <td data-field="pnlPercent">{{ pnl_percent|round(2) }}%</td>
            <td data-field="totalTrades">{{ script.trade_count }}</td>
            <td class="status-field" id="status-field-{{ script.script_name }}">
              {% if script.status == 'Failed' %}
                <span class="badge bg-danger">Failed</span>
              {% elif script.status == 'Skipped' %}
                <span class="badge bg-danger">Skipped</span>
              {% elif script.status == 'Running' %}
                <span class="badge bg-success">Running</span>
              {% elif script.status == 'Paused' %}
                <span class="badge bg-warning text-dark">Paused</span>
              {% elif script.status == 'Waiting' %}
                <span class="badge bg-secondary">Waiting</span>
              {% elif script.status == 'Sold-out' %}
                <span class="badge bg-info text-dark">Sold-out</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ script.status }}</span>
              {% endif %}
            </td>            
            <td class="btn-toolbar">
              <form method="POST">
                {{ csrf_field() }}
                <input type="hidden" name="script_id" value="{{ script.id }}">
                <button type="submit" name="action" value="exit"
                        class="btn btn-outline-danger btn-sm me-1"
                        data-confirm="Are you sure you want to *exit* this script?"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="Sell Script">
                    <i class="bi bi-escape"></i>
                </button>
              </form>
              <!-- Individual pause/resume button -->
              <button class="btn btn-outline-{{ 'success' if script.status=='Paused' else 'warning' }} btn-sm toggle-script-status me-1" data-script-id="{{ script.id }}" data-bs-toggle="tooltip" data-bs-placement="top"
                      title="{% if script.status=='Paused' %}Resume{% else %}Pause{% endif %}">
                  {% if script.status == 'Paused' %}
                      <i class="bi bi-play-fill"></i>
                  {% else %}
                      <i class="bi bi-pause-fill"></i>
                  {% endif %}
              </button>
              <form method="POST">
                {{ csrf_field() }}
                <input type="hidden" name="script_id" value="{{ script.id }}">
                <button type="submit" name="action" value="delete"
                        class="btn btn-outline-danger btn-sm me-1"
                        data-confirm="Are you sure you want to *delete* this script?"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="Delete Script">
                    <i class="bi bi-trash-fill"></i>
                </button>
              </form>
              {% if script.status in ['Failed','Skipped'] %}
                <!-- Retry button: -->
                <button class="btn btn-sm btn-outline-primary btn-retry me-1" data-script-id="{{ script.id }}" data-script-name="{{ script.script_name }}" title="Retry this script">Retry</button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <!-- add this: -->
        <tfoot class="table-light">
          <tr>
            <th colspan="5">Totals</th>
            <th>{{ total_investment }}</th>
            <th>{{ total_current_value }}</th>
            <th>{{ total_pnl }}</th>
            <th>{{ overall_pnl_percent|round(2) }}%</th>
            <th>{{ total_trades }}</th>
            <th colspan="2"></th> <!-- Status + Actions cols -->
          </tr>
        </tfoot>
      </table>
{% endblock %}
{% block scripts %}
<script>
  $(document).ready(function(){
    var selectedScriptsModal = [];
    var debounceTimer;

    // Update the hidden field & UI
    function updateModalSelectedScriptsDisplay(){
      var html = "";
      selectedScriptsModal.forEach(function(script, index){
        html += "<div class='selected-script d-flex justify-content-between align-items-center mb-2' data-index='" + index + "'>" +
                  "<span>" + script.tsym + " (" + script.cname + ")</span>" +
                  "<button type='button' class='btn btn-sm btn-danger remove-modal-script'>Remove</button>" +
                "</div>";
      });
      $("#modalSelectedScripts").html(html);
      $("#modal_selected_scripts").val(JSON.stringify(selectedScriptsModal));
    }

    // Debounced search in modal
    $('#modalScriptSearch').on('input', function(){
      clearTimeout(debounceTimer);
      var q = $(this).val().trim();
      if (q.length < 3){
        $("#modalSearchResults").empty();
        return;
      }
      debounceTimer = setTimeout(function(){
        $.ajax({
          url: "{{ url_for('search_script_api') }}",
          method: "GET",
          dataType: "json",
          data: { search_text: q, exchange: 'NSE' },

          beforeSend: function() {
            // clear previous results & show spinner
            $("#modalSearchResults").empty();
            $("#modalSearchLoader").show();
          },

          complete: function() {
            // hide spinner once the request is done (success or failure)
            $("#modalSearchLoader").hide();
          }
        })
        .done(function(data){
          var resultsHtml = "";

          if (data.error){
            // Server‑side error
            resultsHtml = "<div class='alert alert-danger'>" +
                            "Error: " + data.error +
                          "</div>";
          }
          else if (!data.values || data.values.length === 0){
            // No matches
            resultsHtml = "<div class='alert alert-warning'>No scripts found.</div>";
          }
          else {
            // Render matches
            data.values.forEach(function(item){
              resultsHtml +=
                "<p class='modal-search-result' style='cursor:pointer;' " +
                  "data-tsym='" + item.tsym + "' " +
                  "data-cname='" + item.cname + "' " +
                  "data-token='" + item.token + "'>" +
                  item.tsym + " (" + item.cname + ")" +
                "</p>";
            });
          }

          $("#modalSearchResults").html(resultsHtml);
        })
        .fail(function(xhr, status, err){
          var msg = "Unexpected server error";
          if (xhr.responseJSON && xhr.responseJSON.error){
            msg = "Error: " + xhr.responseJSON.error;
          }
          $("#modalSearchResults").html(
            "<div class='alert alert-danger'>" + msg + "</div>"
          );
        });
      }, 300);
    });

    // Select a script
    $(document).on('click', '.modal-search-result', function(){
      var tsym  = $(this).data('tsym'),
          cname = $(this).data('cname'),
          token = $(this).data('token');

      if (selectedScriptsModal.some(s => s.tsym === tsym)){
        return alert("Script already selected.");
      }
      if (selectedScriptsModal.length >= 10){
        return alert("Maximum of 10 scripts can be selected.");
      }

      selectedScriptsModal.push({ tsym: tsym, cname: cname, token: token });
      updateModalSelectedScriptsDisplay();
      $("#modalSearchResults").empty();
      $("#modalScriptSearch").val('');
    });

    // Remove a selected script
    $(document).on('click', '.remove-modal-script', function(){
      var idx = $(this).closest('.selected-script').data('index');
      selectedScriptsModal.splice(idx, 1);
      updateModalSelectedScriptsDisplay();
    });
  });
</script>
{% endblock %}

