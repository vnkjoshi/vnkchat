{% extends "base.html" %}
{% block title %}Backtest{% endblock %}
{% block content %}
  <h2>Backtest Strategy</h2>
    <form id="backtestForm" method="POST" action="{{ url_for('backtest') }}">
    {{ csrf_field() }}
    <!-- Single Script Selection -->
    <div class="form-group">
      <label for="scriptSearch">Script (Can Select One Script Only)</label>
      <input type="text" id="scriptSearch" name="script" class="form-control" placeholder="Enter script name" required>
      <div id="searchResults" class="mt-2"></div>
    </div>
    
    <!-- Include the common strategy parameters -->
    {% include "_strategy_params.html" %}
    
    <!-- Date Range -->
    <div class="mb-3">
      <label for="start_date">Start Date</label>
      <input type="date" id="start_date" name="start_date" class="form-control" required>
      <small class="form-text text-muted">Select a start date (max 1 year back from today).</small>
    </div>
    <div class="mb-3">
      <label for="end_date">End Date</label>
      <input type="date" id="end_date" name="end_date" class="form-control">
      <small class="form-text text-muted">Optional: End date. If not provided, defaults to today.</small>
    </div>
    <button type="submit" class="btn btn-primary">Run Backtest</button>
  </form>

  {% if result %}
    <h4>Backtest Result:</h4>
    <!-- Display results in a user-friendly table -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Trade Date</th>
          <th>Action</th>
          <th>Price</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody>
        {% for trade in result.trades %}
          <tr>
            <td>{{ trade.date }}</td>
            <td>{{ trade.action }}</td>
            <td>{{ trade.price }}</td>
            <td>{{ trade.quantity }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <p><strong>Total P&L:</strong> {{ result.pnl }}</p>
    <p><strong>Total Trades:</strong> {{ result.trade_count }}</p>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function(){
    // When the user types into the search input
    $('#scriptSearch').on('input', function(){
        var searchText = $(this).val();
        console.log("Input event on #scriptSearch, value:", searchText);
        if(searchText.length > 2){
            $.getJSON("/search_script_api", { search_text: searchText, exchange: 'NSE' }, function(data){
                console.log("Received data from /search_script_api:", data);
                var resultsHtml = "";
                if(data && data.values && data.values.length > 0){
                    $.each(data.values, function(index, item){
                        resultsHtml += "<p class='search-result' style='cursor:pointer;' " +
                                       "data-tsym='" + item.tsym + "' data-cname='" + item.cname + "' data-token='" + item.token + "'>" +
                                       item.tsym + " (" + item.cname + ")" +
                                       "</p>";
                    });
                } else {
                    resultsHtml = "<p>No scripts found.</p>";
                }
                $("#searchResults").html(resultsHtml);
                console.log("Updated #searchResults with:", resultsHtml);
            });
        } else {
            $("#searchResults").empty();
        }
    });

    // When a search result is clicked, hide the search input and display the selected script with a close button
    $(document).on('click', '.search-result', function(){
        var tsym = $(this).data('tsym');
        console.log("Search result clicked, tsym:", tsym);
        // Remove the required attribute and hide the input
        $("#scriptSearch").prop("required", false).hide();
        $("#searchResults").empty();
        // Append a new container to show the selected script with a close (X) button
        var selectedHtml = "<div id='selectedScript' style='margin-top:10px; padding:5px; border:1px solid #ccc; display:inline-block;'>" +
                          "<span>" + tsym + "</span>" +
                          " <button type='button' id='removeSelectedScript' class='btn btn-sm btn-danger'>X</button>" +
                          // Hidden input to be submitted with the form
                          "<input type='hidden' name='script' value='" + tsym + "'>" +
                          "</div>";
        $("#scriptSearch").parent().append(selectedHtml);
    });

    // When the close (X) button is clicked, remove the selected script container and show the search input again
    $(document).on('click', '#removeSelectedScript', function(){
        $("#selectedScript").remove();
        $("#scriptSearch").show();
    });
    $("#backtestForm").on("submit", function(e){
        console.log("Form is being submitted!");
        var scriptValue = $("input[name='script']").val();
        console.log("Script value:", scriptValue);
    });
});
</script>
{% endblock %}
